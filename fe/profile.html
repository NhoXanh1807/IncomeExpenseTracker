<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profile Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css" />
    <link rel="stylesheet" href="/fe/assets/css/profile.css">
</head>

<body>
    <div class="profile">
        <div class="sidebar">
            <a href="/fe/profile.html">
                <div class="sidebar-user" >
                  <div class="modify-image">
                      <img src="/fe/assets/picture/Ellipse 1.png" alt="">
                  </div>
                  <div class="user-name">Michael</div>
              </div>
              </a>
            <div class="sidebar-opts">
                <a href="/fe/dashboard.html" class="dashboard"><i class="fas fa-home"></i> Dashboard</a>
                <a href="/fe/income.html" class="income"><i class="fa-solid fa-arrow-trend-up"></i> Income</a>
                <a href="/fe/expense.html" class="expense"><i class="fa-solid fa-arrow-trend-down"></i> Expense</a>
                <a href="/fe/search_index.html" class="search"><i class="fas fa-search"></i> Search</a>
            </div>
            <div class="sidebar-logout">
                <a href="/fe/index.html"><i class="fa-solid fa-arrow-right-from-bracket"></i> Log out</a>
            </div>
        </div>
        <div class="main" id="profile-detail">
            <div class="modify-image">
                <img id="user-img" src="/fe/assets/picture/Ellipse 1.png" alt="">
                <button class="img-btn" id="change-img-btn">Change the image</button>
            </div>
            <div class="user-detail">
                <div class="user-detail-info">
                    <div class="username">
                        <div class="title">Username</div>
                        <div class="content">
                            Michael
                        </div>
                    </div>
                    <div class="firstname">
                        <div class="title">First name</div>
                        <div class="content">
                            Anh
                        </div>
                    </div>
                    <div class="lastname">
                        <div class="title">Last name</div>
                        <div class="content">
                            Nguyễn
                        </div>
                    </div>
                    <div class="dateofbirth">
                        <div class="title">Date of birth</div>
                        <div class="content">
                            01/01/2004
                        </div>
                    </div>
                    <div class="Email">
                        <div class="title">Email</div>
                        <div class="content">
                            nguyenanh@gmail.com
                        </div>
                    </div>
                    <div class="Address">
                        <div class="title">Address</div>
                        <div class="content">
                            kjasrgisahgoihsogs
                        </div>
                    </div>
                    <div class="Phonenumber">
                        <div class="title">Phone number</div>
                        <div class="content">
                            123456789
                        </div>
                    </div>
                </div>
                <div class="user-detail-modify">
                    <div class="Changepassword">
                        <a href="#" id="change-pass">Change password?</a>
                    </div>

                    <button id="edit-profile">Edit profile</button>

                </div>
            </div>
        </div>
        <div class="update-password" id="update-form">

            <div class="update-password-info">
                <div class="CurrentPassword">
                    <div class="title">Current password</div>
                    <div class="content">
                        <input type="text" placeholder="*********" >
                        <i class="fa-regular fa-eye-slash" ></i>
                    </div>
                </div>
                <div class="NewPassword">
                    <div class="title">New password</div>
                    <div class="content">
                        <input type="text" placeholder="*********">
                        <i class="fa-regular fa-eye-slash"></i>
                    </div>
                </div>
                <div class="ConfirmNewPassword">
                    <div class="title">Confirm new password</div>
                    <div class="content">
                        <input type="text" placeholder="*********">
                        <i class="fa-regular fa-eye-slash"></i>
                    </div>
                </div>
            </div>
            <div class="update-password-btn">
                <button class="cancel" id="cancel">Cancel</button>
                <button class="change">Change</button>
            </div>
        </div>

        <div class="main-2" id="input-profile">
            <div class="modify-image">
                <img src="/fe/assets/picture/Ellipse 1.png" alt="">
            </div>
            <div class="user-detail">
                <div class="user-detail-info">
                    <div class="username">
                        <div class="title">Username</div>
                        <div class="content">
                            <input type="text" placeholder="*********">
                        </div>
                    </div>
                    <div class="firstname">
                        <div class="title">First name</div>
                        <div class="content">
                            <input type="text" placeholder="*********">
                        </div>
                    </div>
                    <div class="lastname">
                        <div class="title">Last name</div>
                        <div class="content">
                            <input type="text" placeholder="*********">
                        </div>
                    </div>
                    <div class="dateofbirth">
                        <div class="title">Date of birth</div>
                        <div class="content">
                            <input type="text" placeholder="*********">
                        </div>
                    </div>
                    <div class="Email">
                        <div class="title">Email</div>
                        <div class="content">
                            <input type="text" placeholder="*********">
                        </div>
                    </div>
                    <div class="Address">
                        <div class="title">Address</div>
                        <div class="content">
                            <input type="text" placeholder="*********">
                        </div>
                    </div>
                    <div class="Phonenumber">
                        <div class="title">Phone number</div>
                        <div class="content">
                            <input type="text" placeholder="*********">
                        </div>
                    </div>
                </div>
                <div class="user-detail-modify">
                    <button>Confirm update</button>
                    <button id="cancel-2">Cancel</button>

                </div>
            </div>
        </div>
    </div>
    <script>
        const profile = document.getElementById('profile-detail');
        const changepass = document.getElementById('change-pass');
        const editbtn = document.getElementById('edit-profile');
        const updateform = document.getElementById('update-form');
        changepass.addEventListener("click", () => {
            profile.style.display = "none";
            updateform.style.display = "flex";
        })
        const cancel = document.getElementById('cancel');
        cancel.addEventListener("click", () => {
            profile.style.display = "flex";
            updateform.style.display = "none";

        })
        const editprofile = document.getElementById('input-profile');
        editbtn.addEventListener("click", () => {
            editprofile.style.display = "flex";
            profile.style.display = "none";
        })
        const cancel2 = document.getElementById('cancel-2');
        cancel2.addEventListener("click", () => {
            editprofile.style.display = "none";
            profile.style.display = "flex";

        })
        const changeImgBtn = document.getElementById('change-img-btn'); // Nút đổi ảnh
    const userImgMain = document.querySelector('.profile .main .modify-image img'); // Ảnh trong .modify-image
    const userImgProfile = document.querySelector('#input-profile .modify-image img'); // Ảnh trong #input-profile
    const dashimg = document.querySelector('.profile .sidebar .sidebar-user .modify-image img')


    document.querySelectorAll('.fa-eye-slash').forEach(icon => {
        icon.addEventListener('click', () => {
            // Find the closest input field to this icon
            const inputField = icon.previousElementSibling;

            if (inputField.type === 'password') {
                inputField.type = 'text';
                icon.classList.remove('fa-eye-slash');
                icon.classList.add('fa-eye');
            } else {
                inputField.type = 'password';
                icon.classList.remove('fa-eye');
                icon.classList.add('fa-eye-slash');
            }
        });
    });
    async function fetchUserData() {
    try {
        const response = await fetch(`/api/users/${userId}`);
        if (!response.ok) throw new Error("Failed to fetch user data");
        const user = await response.json();

        // Hiển thị dữ liệu lên trang
        document.querySelector('.user-name').textContent = user.username;
        document.querySelector('.firstname .content').textContent = user.fname;
        document.querySelector('.lastname .content').textContent = user.lname;
        document.querySelector('.dateofbirth .content').textContent = user.dob;
        document.querySelector('.Email .content').textContent = user.email;
        document.querySelector('.Address .content').textContent = user.addr;
        document.querySelector('.Phonenumber .content').textContent = user.phoneNumber;
        document.querySelector('#user-img').src = user.img;
    } catch (error) {
        console.error(error);
        alert("Error fetching user data. Please try again.");
    }
}


document.addEventListener('DOMContentLoaded', fetchUserData);
async function updateProfile() {
    const updatedData = {
        fname: document.querySelector('.firstname input').value,
        lname: document.querySelector('.lastname input').value,
        dob: document.querySelector('.dateofbirth input').value,
        email: document.querySelector('.Email input').value,
        addr: document.querySelector('.Address input').value,
        phoneNumber: document.querySelector('.Phonenumber input').value,
    };

    if (!confirm("Are you sure you want to update your profile?")) return;

    try {
        const response = await fetch(`/api/users/${userId}/profile`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(updatedData),
        });
        if (!response.ok) throw new Error("Failed to update profile");
        alert('Profile updated successfully!');
        fetchUserData(); // Refresh dữ liệu
    } catch (error) {
        console.error(error);
        alert(error.message);
    }
}

document.querySelector('#edit-profile button').addEventListener('click', updateProfile);


async function changePassword() {
    const oldPassword = document.querySelector('.CurrentPassword input').value;
    const newPassword = document.querySelector('.NewPassword input').value;
    const confirmPassword = document.querySelector('.ConfirmNewPassword input').value;

    if (newPassword !== confirmPassword) {
        alert("New password and confirm password do not match!");
        return;
    }

    try {
        const response = await fetch(`/api/users/${userId}/password?oldPassword=${encodeURIComponent(oldPassword)}&newPassword=${encodeURIComponent(newPassword)}`, {
            method: 'PUT',
        });
        const message = await response.text();
        if (!response.ok) throw new Error(message);
        alert('Password updated successfully!');
    } catch (error) {
        console.error(error);
        alert(error.message);
    }
}

document.querySelector('.change').addEventListener('click', changePassword);

async function updateProfileImage() {
    const newImageUrl = prompt("Enter the URL of the new image:");
    if (!newImageUrl || !/^https?:\/\/.+\.(jpg|jpeg|png|gif|webp)$/i.test(newImageUrl)) {
        alert("Invalid image URL! Please enter a valid URL.");
        return;
    }

    try {
        const response = await fetch(`/api/users/${userId}/profile-image?newImageUrl=${encodeURIComponent(newImageUrl)}`, {
            method: 'PUT',
        });
        if (!response.ok) throw new Error("Failed to update profile image");
        const updatedUser = await response.json();

        // Cập nhật ảnh trên giao diện
        document.querySelector('#user-img').src = updatedUser.img;
        alert("Profile image updated successfully!");
    } catch (error) {
        console.error(error);
        alert(error.message);
    }
}

document.querySelector('#change-img-btn').addEventListener('click', updateProfileImage);
    </script>
</body>

</html>